<h2>Users</h2>

<div class="filters">
  <div class="filter-group">
    <input type="text" [(ngModel)]="nameFilter" (ngModelChange)="applyFilters()"
           placeholder="Filter by name or username...">
    <input type="text" [(ngModel)]="emailFilter" (ngModelChange)="applyFilters()"
           placeholder="Filter by email...">
    <select [(ngModel)]="roleFilter" (ngModelChange)="applyFilters()">
      <option value="">All Roles</option>
      <option value="STARTER">Starter</option>
      <option value="USER">User</option>
      <option value="LIBRARIAN">Librarian</option>
      <option value="ADMIN">Admin</option>
    </select>
    <input type="text" [(ngModel)]="personCodeFilter" (ngModelChange)="applyFilters()"
           placeholder="Filter by person code...">
    <button (click)="clearFilters()">Clear Filters</button>
  </div>
</div>

<table *ngIf="filteredUsers.length > 0; else noUsers" class="user-table">
  <thead>
  <tr>
    <th></th>
    <th>ID</th>
    <th>Username</th>
    <th>Name</th>
    <th>Second Name</th>
    <th>Email</th>
    <th>Phone</th>
    <th>Person Code</th>
    <th>Role</th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <ng-container *ngFor="let user of filteredUsers">
    <tr [class.expanded]="isUserExpanded(user.id)" (click)="toggleUserExpansion(user.id)" class="user-row">
      <td class="expand-icon">
        <span class="material-icons">{{ isUserExpanded(user.id) ? 'expand_less' : 'expand_more' }}</span>
      </td>
      <td>{{ user.id }}</td>
      <td>{{ user.userName }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.secondName }}</td>
      <td>{{ user.email }}</td>
      <td>{{ user.mobileNumber }}</td>
      <td>{{ user.personCode }}</td>
      <td>{{ user.role | enumFormat }}</td>
      <td>
        <button *ngIf="canActivateUser(user)" (click)="activateUser(user.id)">Activate User</button>
        <button *ngIf="canActivateLibrarian(user)" (click)="activateLibrarian(user.id)">Activate Librarian</button>
      </td>
    </tr>
    <tr *ngIf="isUserExpanded(user.id)" class="reservations-row">
      <td colspan="9">
        <div class="reservations-container">
          <h3>User Reservations</h3>
          <div *ngIf="isLoadingReservations(user.id)" class="loading">
            Loading reservations...
          </div>
          <table *ngIf="!isLoadingReservations(user.id) && getUserReservations(user.id).length > 0"
                 class="reservations-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>Book</th>
              <th>Status</th>
              <th>Reservation Date</th>
              <th>Return Date</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let reservation of getUserReservations(user.id)">

              <td>{{ reservation.reservation.id }}</td>
              <td>
                <div class="book-info">
                  <div class="title">{{ reservation.book.title }}</div>
                  <div class="author">{{ reservation.book.author }}</div>
                </div>
              </td>
              <td>{{ reservation.reservation.status | enumFormat }}</td>
              <td>{{ reservation.reservation.createdDate | date:'dd.MM.yyyy HH:mm' }}</td>
              <td>{{ reservation.reservation.termDate | date:'dd.MM.yyyy HH:mm' }}</td>
              <td>
                <button *ngIf="canIssue(reservation)"
                        (click)="issueBook(reservation.reservation.id)"
                        class="action-button issue">
                  Issue
                </button>
                <button *ngIf="canComplete(reservation)"
                        (click)="completeReservation(reservation.reservation.id)"
                        class="action-button complete">
                  Complete
                </button>
                <button *ngIf="canMarkAsLost(reservation)"
                        (click)="markAsLost(reservation.reservation.id)"
                        class="action-button lost">
                  Mark as Lost
                </button>
              </td>
            </tr>
            </tbody>
          </table>
          <p *ngIf="!isLoadingReservations(user.id) && getUserReservations(user.id).length === 0"
             class="no-reservations">
            No reservations found for this user.
          </p>
        </div>
      </td>
    </tr>
  </ng-container>
  </tbody>
</table>
<ng-template #noUsers>
  <p>No users found.</p>
</ng-template>
